# Wrengen - Code Generator for Wren Go Bindings

Wrengen is a code generator that automatically creates Wren foreign function bindings from annotated Go code.

## Installation

```bash
go install github.com/snowmerak/wren.go/wrengen@latest
```

Or run directly:

```bash
go run github.com/snowmerak/wren.go/wrengen -dir .
```

## Usage

### Basic Example

1. **Annotate your Go code** with `//wren:bind` comments:

```go
package myapp

//go:generate go run github.com/snowmerak/wren.go/wrengen -dir .

//wren:bind module=main
type Math struct{}

//wren:bind
func (m *Math) Add(a, b int32) int32 {
    return a + b
}

//wren:bind static
func (m *Math) Multiply(a, b float64) float64 {
    return a * b
}
```

2. **Generate bindings**:

```bash
go generate ./...
```

This creates `myapp_wren.go` with automatic bindings.

3. **Use in Wren**:

```wren
class Math {
  foreign add(a, b)
  foreign static multiply(a, b)
}

var math = Math.new()
System.print(math.add(10, 20))  // 30
System.print(Math.multiply(7, 6))  // 42
```

## Annotation Tags

### Type-level Tags

```go
//wren:bind module=main
type Math struct{}
```

- `module=<name>`: Specifies the Wren module name (default: "main")

### Function/Method Tags

```go
//wren:bind [options]
func (m *Math) Add(a, b int32) int32 { ... }
```

**Options:**

- `static`: Makes the method static in Wren
- `module=<name>`: Override module name
- `class=<name>`: Override class name
- `name=<name>`: Override method name in Wren

**Examples:**

```go
// Instance method
//wren:bind
func (m *Math) Add(a, b int32) int32 { ... }

// Static method
//wren:bind static
func (m *Math) Multiply(a, b float64) float64 { ... }

// Custom name
//wren:bind name=concat
func StringConcat(a, b string) string { ... }

// Custom class
//wren:bind class=Utils static
func Helper() { ... }
```

## Supported Types

### Go â†’ Wren Type Mapping

| Go Type | Wren Type |
|---------|-----------|
| `int`, `int8`, `int16`, `int32`, `int64` | Number |
| `uint`, `uint8`, `uint16`, `uint32`, `uint64` | Number |
| `float32`, `float64` | Number |
| `string` | String |
| `bool` | Bool |
| `error` (return value) | Aborts fiber on error |

### Return Values

Functions can return:

- **Single value**: `func Add(a, b int) int`
- **Value + error**: `func Divide(a, b float64) (float64, error)`

When returning `(value, error)`, the generated code automatically handles errors by aborting the Wren fiber.

## Example with Error Handling

**Go code:**

```go
//wren:bind
func (m *Math) Divide(a, b float64) (float64, error) {
    if b == 0 {
        return 0, errors.New("division by zero")
    }
    return a / b, nil
}
```

**Generated code:**

```go
wrengo.RegisterForeignMethod("main", "Math", false, "divide(_,_)", func(vm *wrengo.WrenVM) {
    a := vm.GetSlotDouble(1)
    b := vm.GetSlotDouble(2)
    receiver := &Math{}
    result, err := receiver.Divide(a, b)
    if err != nil {
        vm.SetSlotString(0, err.Error())
        vm.AbortFiber(0)
        return
    }
    vm.SetSlotDouble(0, result)
})
```

## Command-line Options

```bash
wrengen [options]

Options:
  -dir string
        Directory to scan for Go files (default ".")
  -output string
        Output file name (default: "<package>_wren.go")
```

## Generated Code

The generator creates:

- An `init()` function that registers all bindings automatically
- A `RegisterWrenBindings()` function for manual registration
- Type-safe conversions between Go and Wren types
- Automatic error handling

**Example generated file (`math_wren.go`):**

```go
// Code generated by wrengen. DO NOT EDIT.

package myapp

import wrengo "github.com/snowmerak/wren.go"

func init() {
    RegisterWrenBindings()
}

func RegisterWrenBindings() {
    // Math.add
    wrengo.RegisterForeignMethod("main", "Math", false, "add(_,_)", func(vm *wrengo.WrenVM) {
        a := int32(vm.GetSlotDouble(1))
        b := int32(vm.GetSlotDouble(2))
        receiver := &Math{}
        result := receiver.Add(a, b)
        vm.SetSlotDouble(0, float64(result))
    })
}
```

## Integration with `go generate`

Add this comment to your Go files:

```go
//go:generate go run github.com/snowmerak/wren.go/wrengen -dir .
```

Then run:

```bash
go generate ./...
```

## Full Example

See `example/codegen/` for a complete working example.

## Limitations

- Currently supports basic types (numbers, strings, bools)
- Lists and maps not yet supported (coming in Phase 2)
- Foreign classes not yet supported (coming in Phase 3)
- Method names are automatically converted to camelCase

## Future Features

### Phase 2 (Planned)
- List and Map type support
- Multiple return values
- Custom type converters

### Phase 3 (Planned)
- Foreign class generation
- Wren stub file generation
- Documentation generation
